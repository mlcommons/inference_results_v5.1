#!/bin/bash

source $MODEL_INIT_DIR/init_env_shared
# Validate and set Tensor parallel and Instances

if (( XPU_COUNT > 0 )); then
    # XPU
    export PP=4
    export NUM_INSTS=$((XPU_COUNT / (TP*PP)))
    export BATCH_SIZE=768
    export MAX_NUM_BATCHED_TOKENS=256
    export VLLM_XPU_ATTN_IMPL=chunk_page
    export VLLM_XPU_PA_IMPL=triton
    export VLLM_USE_SEPARATE_QUANT=1
    export VLLM_FUSE_NORM_QUANT=1
    export VLLM_FUSE_SILU_QUANT=1
    export VLLM_ENABLE_SEQ_PARALLEL=0
    # export VLLM_FUSE_SILU_QUANT=1 # Problematic
else
    # CPU
    export NUM_NUMA_NODES=$(lscpu | grep "NUMA node(s)" | awk '{print $NF}')
    export NUM_CORES=$(($(lscpu | grep "Socket(s):" | awk '{print $2}') * $(lscpu | grep "Core(s) per socket:" | awk '{print $4}')))
    export CORES_PER_NODE=$(($NUM_CORES / $NUM_NUMA_NODES))
    export CORES_PER_INST=$CORES_PER_NODE
    export INSTS_PER_NODE=$((${CORES_PER_NODE} / ${CORES_PER_INST}))
    export NUM_INSTS=$((${INSTS_PER_NODE} * ${NUM_NUMA_NODES}))
    export OMP_NUM_THREADS=${CORES_PER_INST} 

    export BATCH_SIZE=128
    #Batch size * 4 * 40 (20 if 8-bit kv cache) / 1024
    export VLLM_CPU_KVCACHE_SPACE=20
    export MAX_NUM_BATCHED_TOKENS=2048
fi
