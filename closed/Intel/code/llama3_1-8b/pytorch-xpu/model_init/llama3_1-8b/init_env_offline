#!/bin/bash

source $MODEL_INIT_DIR/init_env_shared
# Validate and set Tensor parallel and Instances
export TP=1
export NUM_INSTS=1

if (( XPU_COUNT > 0 )); then
    # XPU
    export TP=1
    export NUM_INSTS=$((XPU_COUNT / TP))
    export BATCH_SIZE=128
    QPS_PER_XPU=6.25
    TARGET_QPS=$(echo "scale=8; $QPS_PER_XPU * $XPU_COUNT" | bc)
    sed -i "/llama3_1-8b.Offline.target_qps/c\llama3_1-8b.Offline.target_qps = $TARGET_QPS" $ROOT_DIR/user.conf
else
    # CPU
    export NUM_NUMA_NODES=$(lscpu | grep "NUMA node(s)" | awk '{print $NF}')
    export NUM_CORES=$(($(lscpu | grep "Socket(s):" | awk '{print $2}') * $(lscpu | grep "Core(s) per socket:" | awk '{print $4}')))
    export CORES_PER_NODE=$(($NUM_CORES / $NUM_NUMA_NODES))
    export CORES_PER_INST=6
    export INSTS_PER_NODE=$((${CORES_PER_NODE} / ${CORES_PER_INST}))
    export NUM_INSTS=$((${INSTS_PER_NODE} * ${NUM_NUMA_NODES}))
    export OMP_NUM_THREADS=${CORES_PER_INST} 

    export BATCH_SIZE=256
    #Batch size * 8 * 16 (8 if 8-bit kv cache) / 1024
    export VLLM_CPU_KVCACHE_SPACE=20
    export MAX_NUM_BATCHED_TOKENS=3072
fi
