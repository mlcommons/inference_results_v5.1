#!/bin/bash

# This script is generated by the MLPerf Script Creator.

set -euo pipefail
source gui/script_utils.sh

export SUBMITTER="Azure"
export SYSTEM_NAME="ND_GB200_v6"
export LOG_DIR="build/logs/default"
export NO_DISPLAY_RESULTS=1
export RESULTS_SEARCH_DIR="build/logs/default"
llama3_1_405b() {
    log_info "Running llama3_1-405b workload in ['Offline', 'Server'] scenario(s)"
    LOG_DIR=$LOG_DIR/PerformanceOnly make run_harness RUN_ARGS="--benchmarks=llama3_1-405b --scenarios=Offline"
    LOG_DIR=$LOG_DIR/AccuracyOnly make run_harness RUN_ARGS="--benchmarks=llama3_1-405b --scenarios=Offline --test_mode=AccuracyOnly"
    LOG_DIR=$LOG_DIR/PerformanceOnly make run_harness RUN_ARGS="--benchmarks=llama3_1-405b --scenarios=Server"
    LOG_DIR=$LOG_DIR/AccuracyOnly make run_harness RUN_ARGS="--benchmarks=llama3_1-405b --scenarios=Server --test_mode=AccuracyOnly"
}

run_compliance_tests() {
    make stage_results
    rm -rf build/compliance_logs
    make run_audit_harness RUN_ARGS="--benchmarks=llama3_1-405b --scenarios=Offline"
    make run_audit_harness RUN_ARGS="--benchmarks=llama3_1-405b --scenarios=Server"
    make stage_compliance
}

# Function: all
# Description: Run all benchmark functions
all() {
    log_info "Running all benchmarks..."
    llama3_1_405b
    log_success "All benchmarks completed successfully!"
    display_results
}

# Function: display_results
# Description: Display results from completed benchmark runs
display_results() {
    make display_results
}

# Function: help
# Description: Display usage information
help() {
    cat << EOF
Usage: $0 <command> [arguments...]

Available commands:
    llama3_1-405b        - Run llama3_1-405b benchmark
    all                  - Run all benchmarks
    display_results      - Display results from completed benchmark runs
    run_compliance_tests - Run compliance tests. ONLY RUN THIS AFTER ALL BENCHMARKS ARE RUN.
    help                 - Display this help message

Examples:
    $0 llama3_1-405b
    $0 all
    $0 display_results
    $0 help

EOF
}

# Main function to route commands
main() {
    # Check if no arguments provided
    if [ $# -eq 0 ]; then
        log_error "No command specified"
        help
        exit 1
    fi

    local command="$1"
    shift  # Remove the command from arguments list

    # Route to appropriate function
    case "$command" in
        "llama3_1-405b")
            llama3_1_405b "$@"
            ;;
        "all")
            all "$@"
            ;;
        "display_results")
            display_results "$@"
            ;;
        "run_compliance_tests")
            run_compliance_tests "$@"
            ;;
        "help"|"-h"|"--help")
            help
            ;;
        *)
            log_error "Unknown command: $command"
            echo
            help
            exit 1
            ;;
    esac
}

# Only run main if script is executed directly (not sourced)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi