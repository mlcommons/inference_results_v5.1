ARG BASE_IMAGE
FROM $BASE_IMAGE

ARG DEBIAN_FRONTEND=noninteractive
ARG VLLM_DIR=setup/vllm
ARG ARCH

# Re-install vllm
COPY ${VLLM_DIR} /lab-mlperf-inference/vllm
RUN cd /lab-mlperf-inference/vllm \
    && python3 -m pip uninstall -y vllm \
    && if [ -f tests/build_cython.py ]; then \
           CFLAGS='-O3' python3 tests/build_cython.py build_ext --inplace; \
       else \
           pip install -U 'setuptools<80'; \
           CFLAGS='-O3' python3 setup_cython.py build_ext --inplace; \
       fi \
    && GPU_TARGETS=${ARCH} SCCACHE_IDLE_TIMEOUT=1800 python3 setup.py develop

WORKDIR /lab-mlperf-inference/submission/
